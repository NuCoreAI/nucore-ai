{
  "type": "function",
  "function": {
    "name": "routine_automation_tool",
    "description": "Automation/optimization routines based on device status and conditions",
    "parameters": {
      "type": "object",
      "required": ["tool","args"],
      "properties": {
        "tool": {
          "type": "string",
          "const": "Routine",
          "description": "The tool name indicating the type of operation to perform"
        },
        "args": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "name":{
                        "type": "string",
                        "description": "The name of the routine"
                    },
                    "parent":{
                        "type": "integer",
                        "const": 0, 
                        "description": "The parent routine ID if this is a subroutine, else null"
                    },
                    "enabled":{
                        "type": "boolean",
                        "const": true,
                        "description": "Whether the routine is enabled or disabled"
                    },
                    "comment":{
                        "type": "string",
                        "description": "A short description for what this routine does"
                    },
                    "if": {
                    "type": "array",
                    "description": "An array of SUBEXPRESSIONS connected by **LOGICAL OPERATORS**",
                    "items": {
                        "oneOf": [
                            {
                                "type": "object",
                                "description": "Logical Operator",
                                "properties": {
                                    "logic": {
                                        "type": "string",
                                        "enum": ["and", "or", "(", ")"]
                                    }
                                },
                                "required": ["logic"],
                                "additionalProperties": false
                            },
                            {
                                "type": "object",
                                "description": "**COS** Subexpression",
                                "properties": {
                                "device": { 
                                    "type": "string", 
                                    "description": "The Device ID (id) for the device in DEVICE STRUCTURE."
                                },
                                "status": { 
                                    "type": "string", 
                                    "description": "The Property ID (id) of the device in DEVICE STRUCTURE that's tested in the subexpression against the value."
                                },
                                "comp": { 
                                    "type": "string", "enum": [">", ">=", "<", "<=", "==", "!="],
                                    "description": "The comparison operator for the subexpression."
                                },
                                "value": {
                                    "type": "number",
                                    "description": "The value to compare against. See **GLOBAL CUSTOMER VALUE CONVERSION RULES**."
                                },
                                "uom": { 
                                    "type": "integer",
                                    "description": "The uom_id for the property from DEVICE STRUCTURE. See **GLOBAL UOM RULES**"
                                },
                                "precision": { 
                                    "type": "integer" , 
                                    "description": "The precision for the property value. SEE **GLOBAL PRECISION RULES**"
                                }
                                },
                                "required": ["device", "status", "comp", "value", "uom", "precision"],
                                "additionalProperties": false
                            },
                            {
                                "type": "object",
                                "description": "**COC** Subexpression",
                                "properties": {
                                "device": { 
                                    "type": "string",
                                    "description": "The Device ID (id) for the device in DEVICE STRUCTURE."
                                },
                                "eq": { 
                                    "type": "string", 
                                    "enum": ["is", "isnot"],
                                    "description": "**EQUALITY OPERATOR** for the control subexpression."
                                },
                                "control": { 
                                    "type": "string" ,
                                    "description": "The Command ID (id) for the **Send Command** for the device in DEVICE STRUCTURE."
                                },
                                "parameters": {
                                    "type": "array",
                                    "description": "The applicable parameters for the command",
                                    "items": {
                                    "type": "object",
                                    "properties": {
                                        "id": { 
                                            "type": "string",
                                            "description": "The unique identifier (id) for the parameter from for the command from DEVICE STRUCTURE. If none, use n/a"
                                        },
                                        "value": {
                                            "type": "number",
                                            "description": "Always a number. See **GLOBAL CUSTOMER VALUE CONVERSION RULES**."
                                        },
                                        "uom": { 
                                            "type": "integer",
                                            "description": "The uom_id for the parameter from DEVICE STRUCTURE. See **GLOBAL UOM RULES**" 
                                        },
                                        "precision": { 
                                            "type": "integer",
                                            "description": "The precision for the parameter value."
                                        }
                                    },
                                    "required": ["id", "value", "uom", "precision"],
                                    "additionalProperties": false
                                    }
                                }
                                },
                                "required": ["device", "eq", "control"],
                                "additionalProperties": false
                            },
                            {
                                "type": "object",
                                "description": "**SCHEDULE** Subexpression",
                                "properties": {
                                
                                "oneOf": [
                                {
                                    "type": "object",
                                    "description": "Schedule subexpression - **at** a specific time **every day** or a **specific datetime**", 
                                    "properties": {
                                        "at": {
                                            "type": "object",
                                            "oneOf": [
                                            {
                                                "type": "object",
                                                "description": "Specific time **every day**",
                                                "properties": {
                                                    "time": {"type": "string", "description": "format HH:MM:SS in 24-hour time"}
                                                }
                                            },
                                            {
                                                "type":"object",
                                                "description": "sunrise with offset in seconds **every day**",
                                                "properties": {
                                                    "sunrise": { "type": "integer", "description": "Offset in **seconds** before (negative) or after (positive) sunrise time" }
                                                }
                                            },
                                            {
                                                "type":"object",
                                                "description": "sunset with offset in seconds **every day**",
                                                "properties": {
                                                    "sunset": { "type": "integer", "description": "Offset in **seconds** before (negative) or after (positive) sunset time" }
                                                }
                                            }
                                        ],
                                        "date": { "type": "string", "description": "Date in YYYY/MM/DD format. If provided, the time is for that specific date. If omitted, the time is for everyday." }
                                        }
                                    },
                                    "required": ["at"],
                                    "minProperties": 1,
                                    "additionalProperties": false
                                },
                                {
                                    "type": "object",
                                    "description": "Weekly schedule subexpression at specific time on specific days",
                                    "properties": {
                                        "weekly": {
                                        "type": "object",
                                        "properties": {
                                            "days": { "type": "string", "description": "any subset of sun,mon,tue,wed,thu,fri,sat all lowercase with no spaces in between"},
                                            "at": {
                                                "type": "object",
                                                "oneOf": [
                                                    {
                                                        "type": "object",
                                                        "description": "Specific time on days defined by `days`",
                                                        "properties": {
                                                            "time": { "type": "string", "description": "format HH:MM:SS in 24-hour time" }
                                                        }
                                                    },
                                                    {
                                                        "type":"object",
                                                        "description": "sunrise with offset in seconds on days defined by `days`",
                                                        "properties": {
                                                            "sunrise": { "type": "integer", "description": "Offset in **seconds** before (negative) or after (positive) sunrise time" }
                                                        }
                                                    },
                                                    {
                                                        "type":"object",
                                                        "description": "sunset with offset in seconds on days defined by `days`",
                                                        "properties": {
                                                            "sunset": { "type": "integer", "description": "Offset in **seconds** before (negative) or after (positive) sunset time" }
                                                        }
                                                    }
                                                ]
                                            }
                                        },
                                        "minProperties": 1,
                                        "additionalProperties": false,
                                        "required": ["days","at"]
                                        }
                                    },
                                    "required": ["weekly"],
                                    "additionalProperties": false
                                },
                                {
                                    "type": "object",
                                    "description": "Weekly schedule subexpression for a **duration** using **from/to** and **day** to signify day boundaries (next day, etc.)",
                                    "properties": {
                                        "weekly": {
                                        "type": "object",
                                        "properties": {
                                            "days": { "type": "string", "description": "any subset of sun,mon,tue,wed,thu,fri,sat all lowercase with no spaces in between"},
                                            "from": {
                                                "type": "object",
                                                "oneOf": [
                                                    {
                                                        "type":"object",
                                                        "description": "Specific time on days defined by `days`",
                                                        "properties": {
                                                            "time": { "type": "string", "description": "format HH:MM:SS in 24-hour time" }
                                                        }
                                                    },
                                                    {
                                                        "type":"object",
                                                        "description": "sunrise with offset in seconds on days defined by `days`",
                                                        "properties": {
                                                            "sunrise": { "type": "integer", "description": "Offset in **seconds** before (negative) or after (positive) sunrise time" }
                                                        }
                                                    },
                                                    {
                                                        "type":"object",
                                                        "description": "sunset with offset in seconds on days defined by `days`",
                                                        "properties": {
                                                            "sunset": { "type": "integer", "description": "Offset in **seconds** before (negative) or after (positive) sunset time" }
                                                        }
                                                    }
                                                ]
                                            },
                                            "to": {
                                                "type": "object",
                                                "oneOf": [
                                                    {
                                                        "type":"object",
                                                        "description": "Specific time on days defined by `days`",
                                                        "properties": { 
                                                            "time": { "type": "string", "description": "format HH:MM:SS in 24-hour time" }}
                                                    },
                                                    {
                                                        "type":"object",
                                                        "description": "sunrise with offset in seconds on days defined by `days`",
                                                        "properties": {
                                                            "sunrise": { "type": "integer", "description": "Offset in **seconds** before (negative) or after (positive) sunrise time" }
                                                        }
                                                    },
                                                    {
                                                        "type":"object",
                                                        "description": "sunset with offset in seconds on days defined by `days`",
                                                        "properties": {
                                                            "sunset": { "type": "integer", "description": "Offset in **seconds** before (negative) or after (positive) sunset time" }
                                                        }
                                                    }
                                                ]
                                            },
                                            "day": { "type": "integer", "description": "is an integer >= 0 for the number of days of duration after the start time. 0 = today, 1 = next day (tomorrow), 2 = two days from now (day after tomorrow), and so on."
                                            }
                                        },
                                        "additionalProperties": false,
                                        "required": ["days","from", "to","day"]
                                        }
                                    }
                                },
                                {
                                    "type": "object",
                                    "description": "Weekly schedule subexpression for a **duration** using **from/for**" ,
                                    "properties": {
                                        "weekly": {
                                        "type": "object",
                                        "properties": {
                                            "days": { "type": "string", "description": "any subset of sun,mon,tue,wed,thu,fri,sat all lowercase with no spaces in between"},
                                            "from": {
                                                "type": "object",
                                                "oneOf": [
                                                    {
                                                        "type": "object",
                                                        "description": "Specific time on days defined by `days`",
                                                        "properties": {
                                                            "time": { "type": "string", "description": "format HH:MM:SS in 24-hour time"}
                                                        }
                                                    },
                                                    {
                                                        "type":"object", 
                                                        "description": "sunrise with offset in seconds on days defined by `days`",
                                                        "properties": {
                                                            "sunrise": { "type": "integer", "description": "Offset in **seconds** before (negative) or after (positive) sunrise time" }
                                                        }
                                                    },
                                                    {
                                                        "type":"object",
                                                        "description": "sunset with offset in seconds on days defined by `days`",
                                                        "properties": {
                                                            "sunset": { "type": "integer", "description": "Offset in **seconds** before (negative) or after (positive) sunset time" }
                                                        }
                                                    }
                                                ]
                                            },
                                            "for": { "type": "object", "description": "Duration in HH:MM:SS format",
                                                "properties": {
                                                    "hours": { "type": "integer", "description": "number of hours in the duration. 0 if not provided" },
                                                    "minutes": { "type": "integer", "description": "number of minutes in the duration. 0 if not provided" },
                                                    "seconds": { "type": "integer", "description": "number of seconds in the duration. 0 if not provided" }
                                            }
                                        }
                                        },
                                        "additionalProperties": false,
                                        "required": ["days","from","for"]
                                        }
                                    }
                                },
                                {
                                    "type": "object",
                                    "description": "Schedule subexpression for a **duration** spanning dates and times", 
                                    "properties": {
                                        "from": {
                                            "type": "object",
                                            "oneOf": [
                                                {
                                                    "type": "object",
                                                    "description": "Specific time",
                                                    "properties": {
                                                        "time": { "type": "string", "description": "format HH:MM:SS in 24-hour time" }
                                                    }
                                                },
                                                {
                                                    "type":"object",
                                                    "description": "sunrise with offset in seconds",
                                                    "properties": {
                                                        "sunrise": { "type": "integer", "description": "Offset in **seconds** before (negative) or after (positive) sunrise time" }
                                                    }
                                                },
                                                {
                                                    "type":"object",
                                                    "description": "sunset with offset in seconds",
                                                    "properties": {
                                                        "sunset": { "type": "integer", "description": "Offset in **seconds** before (negative) or after (positive) sunset time" }
                                                    }
                                                }
                                            ],
                                            "date": { "type": "string", "description": "Date in YYYY/MM/DD format. If provided, the time is for that specific date. If omitted, the time is for everyday." }
                                        },
                                        "to": {
                                            "type": "object",
                                            "oneOf": [
                                                {
                                                    "type": "object",
                                                    "description": "Specific time",
                                                    "properties": {
                                                        "time": { "type": "string", "description": "format HH:MM:SS in 24-hour time" }
                                                    }
                                                },
                                                {
                                                    "type":"object",
                                                    "description": "sunrise with offset in seconds",
                                                    "properties": {
                                                        "sunrise": { "type": "integer", "description": "Offset in **seconds** before (negative) or after (positive) sunset time" }
                                                    }
                                                },
                                                {
                                                    "type":"object",
                                                    "description": "sunset with offset in seconds",
                                                    "properties": {
                                                        "sunset": { "type": "integer", "description": "Offset in **seconds** before (negative) or after (positive) sunset time" }
                                                    }
                                                }
                                            ],
                                            "date": { "type": "string", "description": "Date in YYYY/MM/DD format. If provided, the time is for that specific date. If omitted, the time is for everyday." }
                                        }
                                    },
                                    "additionalProperties": false,
                                    "required": ["from","to"]
                                }
                                ]
                            }
                           }
                        ]
                    }
                    },
                    "then": {
                    "type": "array",
                    "description": "Array of actions to execute when the conditions are evaluated to true.",
                    "items": {
                        "type": "object",
                        "properties": {
                        "device": { 
                            "type": "string",
                            "description": "The Device ID (id) for the device in DEVICE STRUCTURE."
                        },
                        "command": { 
                            "type": "string",
                            "description": "The **Accept Command** ID (id) for the command to execute on the device."
                        },
                        "parameters": {
                            "type": "array",
                            "description": "The parameters for the command",
                            "items": {
                            "type": "object",
                            "properties": {
                                "id": { 
                                    "type": "string",
                                    "description": "The unique identifier (id) for the parameter from for the command from DEVICE STRUCTURE. If none, use n/a"
                                },
                                "value": {
                                    "type": "number",
                                    "description": "Always a number. See **GLOBAL CUSTOMER VALUE CONVERSION RULES**."
                                },
                                "uom": { 
                                    "type": "integer",
                                    "description": "The uom_id for the parameter from DEVICE STRUCTURE. See **GLOBAL UOM RULES**" 
                                },
                                "precision": { 
                                    "type": "integer",
                                    "description": "The precision for the parameter value."
                                }
                            },
                            "required": ["id", "value", "uom", "precision"],
                            "additionalProperties": false
                            }
                        }
                        },
                        "required": ["device", "command"],
                        "additionalProperties": false
                    }
                },
                "else": {
                    "type": "array",
                    "description": "Array of actions when the conditions are evaluated to false.",
                    "items": {
                        "type": "object",
                        "properties": {
                        "device": { 
                            "type": "string",
                            "description": "The Device ID (id) for the device in DEVICE STRUCTURE."
                        },
                        "command": { 
                            "type": "string",
                            "description": "The **Accept Command** ID (id) for the command to execute on the device."
                        },
                        "parameters": {
                            "type": "array",
                            "description": "The parameters for the command",
                            "items": {
                            "type": "object",
                            "properties": {
                                "id": { 
                                    "type": "string",
                                    "description": "The unique identifier (id) for the parameter from for the command from DEVICE STRUCTURE. If none, use n/a"
                                },
                                "value": {
                                    "type": "number",
                                    "description": "Always a number. See **GLOBAL CUSTOMER VALUE CONVERSION RULES**."
                                },
                                "uom": { 
                                    "type": "integer",
                                    "description": "The uom_id for the parameter from DEVICE STRUCTURE. See **GLOBAL UOM RULES**" 
                                },
                                "precision": { 
                                    "type": "integer",
                                    "description": "The precision for the parameter value."
                                }
                            },
                            "required": ["id", "value", "uom", "precision"],
                            "additionalProperties": false
                            }
                        }
                        },
                        "required": ["device", "command"],
                        "additionalProperties": false
                    }
                }
            },
            "required": ["if", "then", "else"],
            "additionalProperties": false
        }
      }
   }
}}}